AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: |
  FHIR Validator Cloudwatch alarms and related resources

Parameters:
  StackName:
    Type: String

  EnableAlerts:
    Type: String

  FHIRValidatorUKCoreLambdaName:
    Type: String

Resources:
  FHIRValidatorErrorLogsMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterName: FHIRValidatorErrors
      # Catch any messages that are strings that contain line breaks (Java stack traces)
      FilterPattern: '{ ($.message = "error") }'
      LogGroupName:
        Fn::ImportValue: !Sub ${StackName}:FHIRValidatorUKCoreResources:LambdaLogGroupName
      MetricTransformations:
        - MetricNamespace: LambdaLogFilterMetrics
          MetricName: ErrorCount
          MetricValue: 1
          Unit: Count

  FHIRValidatorErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Count of FHIR Validator system errors
      AlarmName: !Sub ${StackName}_FHIR_Validator_Errors
      Namespace: LambdaLogFilterMetrics
      MetricName: ErrorCount
      Dimensions:
        - Name: FunctionName
          Value: !Ref FHIRValidatorUKCoreLambdaName
      Period: 60 #seconds
      EvaluationPeriods: 1
      Statistic: Sum
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      Unit: Count
      TreatMissingData: notBreaching
      ActionsEnabled: !Ref EnableAlerts
      AlarmActions:
        - !ImportValue lambda-resources:SlackAlertsSnsTopicArn
      InsufficientDataActions:
        - !ImportValue lambda-resources:SlackAlertsSnsTopicArn
      OKActions:
        - !ImportValue lambda-resources:SlackAlertsSnsTopicArn
